name: Update and Obfuscate Worker

on:
  schedule:
    - cron: '0 0 * * 0'     # æ¯å‘¨æ—¥ 00:00 UTC è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:
    inputs:
      version_tag:
        description: "æŒ‡å®šè¦æ›´æ–°çš„ BPB ç‰ˆæœ¬ï¼ˆä¾‹å¦‚ v3.2.3ï¼‰ï¼Œä¸ºç©ºåˆ™è‡ªåŠ¨æ£€æµ‹æœ€æ–°ç‰ˆæœ¬"
        required: false
        default: ""

permissions:
  contents: write

env:
  RELEASE_REPO: bia-pain-bache/BPB-Worker-Panel
  WORKER_ASSET_NAME: worker.js
  OBFUSCATOR_CONFIG: .obfuscator.json

jobs:
  update-and-obfuscate:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Node.js + Cache
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip
          npm install --no-audit --no-fund javascript-obfuscator@latest

      - name: ğŸ” è·å–ç›®æ ‡ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨æˆ–æ‰‹åŠ¨ï¼‰
        id: get_version
        run: |
          if [ -n "${{ github.event.inputs.version_tag }}" ]; then
            version="${{ github.event.inputs.version_tag }}"
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬: $version"
          else
            version=$(curl -s https://api.github.com/repos/${RELEASE_REPO}/releases/latest | jq -r '.tag_name')
            echo "æ£€æµ‹åˆ°æœ€æ–°ç‰ˆæœ¬: $version"
          fi

          if [ -z "$version" ] || [ "$version" = "null" ]; then
            echo "âŒ æ— æ³•è·å–ç‰ˆæœ¬å·"
            exit 1
          fi

          echo "target_version=$version" >> $GITHUB_ENV
          echo "ç›®æ ‡ç‰ˆæœ¬: $version"

      - name: ğŸ“– è¯»å–å½“å‰ç‰ˆæœ¬å·
        id: read_version
        run: |
          if [ -f "version.txt" ]; then
            current_version=$(cat version.txt | tr -d '\n' | tr -d '\r')
          else
            current_version=""
          fi
          echo "å½“å‰ç‰ˆæœ¬: $current_version"
          echo "current_version=$current_version" >> $GITHUB_ENV

      - name: ğŸ” åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        id: check_update
        run: |
          if [ "${{ env.current_version }}" = "${{ env.target_version }}" ]; then
            echo "need_update=false" >> $GITHUB_ENV
            echo "âœ… æ— éœ€æ›´æ–°"
          else
            echo "need_update=true" >> $GITHUB_ENV
            echo "ğŸš€ æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬: ${{ env.target_version }}"
          fi

      - name: â¬‡ï¸ ä¸‹è½½ worker.js
        if: env.need_update == 'true'
        run: |
          url="https://github.com/${RELEASE_REPO}/releases/download/${{ env.target_version }}/${WORKER_ASSET_NAME}"
          echo "ä¸‹è½½åœ°å€: $url"
          curl --fail -L --retry 5 --retry-delay 2 -o origin.js "$url"
          ls -lh origin.js

      - name: ğŸ§± Sanity Check åŸå§‹æ–‡ä»¶
        if: env.need_update == 'true'
        run: |
          if [ ! -s origin.js ]; then
            echo "âŒ origin.js æ–‡ä»¶ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
            exit 1
          fi
          filesize=$(wc -c < origin.js)
          echo "åŸå§‹æ–‡ä»¶å¤§å°: ${filesize} å­—èŠ‚"
          if [ "$filesize" -lt 10000 ]; then
            echo "âš ï¸ æ–‡ä»¶å¼‚å¸¸å°ï¼Œå¯èƒ½ä¸‹è½½é”™è¯¯"
          fi

      - name: ğŸ›ï¸ åˆ›å»ºæ··æ·†é…ç½®æ–‡ä»¶
        if: env.need_update == 'true'
        run: |
          cat > $OBFUSCATOR_CONFIG <<'EOF'
{
  "compact": true,
  "identifierNamesGenerator": "hexadecimal",
  "renameGlobals": false,
  "stringArray": false,
  "transformObjectKeys": false,
  "selfDefending": false,
  "simplify": true
}
EOF
          echo "âœ… å·²ç”Ÿæˆæ··æ·†é…ç½®æ–‡ä»¶: $OBFUSCATOR_CONFIG"

      - name: ğŸŒ€ æ··æ·† JS ä»£ç 
        if: env.need_update == 'true'
        run: |
          npx javascript-obfuscator origin.js --config $OBFUSCATOR_CONFIG --output _worker.js
          echo "// Auto obfuscated at $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> _worker.js
          ls -lh _worker.js

      - name: ğŸ§  Sanity Check æ··æ·†ç»“æœ
        if: env.need_update == 'true'
        run: |
          [ ! -f _worker.js ] && { echo "âŒ æ··æ·†æ–‡ä»¶ç¼ºå¤±"; exit 1; }
          wc -c _worker.js
          grep -q "Cloudflare" _worker.js && echo "âš ï¸ å…³é”®å­—ä»å­˜åœ¨ï¼ˆæ­£å¸¸ï¼‰" || echo "âœ… å·²æ··æ·†"

      - name: ğŸ’¾ æ›´æ–° version.txt
        if: env.need_update == 'true'
        run: echo "${{ env.target_version }}" > version.txt

      - name: ğŸ“¦ ä¿å­˜æ··æ·†äº§ç‰©
        if: env.need_update == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: obfuscated-${{ env.target_version }}
          path: |
            origin.js
            _worker.js
            version.txt

      - name: ğŸ§¾ æäº¤æ›´æ–°
        if: env.need_update == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            ğŸ” Obfuscate _worker.js (version: ${{ env.target_version }})
          commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          file_pattern: |
            _worker.js
            version.txt

      - name: ğŸ·ï¸ åˆ›å»º GitHub Release
        if: env.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.target_version }}
          name: "Obfuscated Worker ${{ env.target_version }}"
          body: |
            è‡ªåŠ¨æ··æ·†æ„å»ºç‰ˆæœ¬: **${{ env.target_version }}**

            - æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M UTC")
            - è‡ªåŠ¨æ‰§è¡Œäº: GitHub Actions
          files: |
            _worker.js
            origin.js

      - name: â˜ï¸ ï¼ˆé¢„ç•™ï¼‰è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare Worker
        if: env.need_update == 'true'
        run: |
          echo "å¦‚éœ€å¯ç”¨ Cloudflare è‡ªåŠ¨éƒ¨ç½²ï¼Œè¯·åœ¨æ­¤æ·»åŠ  wrangler publish æµç¨‹ã€‚"
          echo "å½“å‰æœªå¯ç”¨è‡ªåŠ¨éƒ¨ç½²ã€‚"

      - name: âœ… æµç¨‹å®ŒæˆçŠ¶æ€
        run: |
          if [ "${{ env.need_update }}" = "true" ]; then
            echo "âœ… å·²å®Œæˆæ··æ·†ä¸æ›´æ–°ï¼š${{ env.target_version }}"
          else
            echo "ğŸŸ¢ å½“å‰ç‰ˆæœ¬å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°ã€‚"
          fi
